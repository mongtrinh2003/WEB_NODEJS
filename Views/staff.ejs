<!doctype html>
<html lang="en">

<head>
    <title>Quản lí nhân viên</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../public/css/notifcation.css" type="text/css" />

</head>

<body>
    <div id="myNotification">thông báo!</div>
    <header>
        <nav class=" navbar navbar-expand-lg fixed-top navHeader navbar-dark bg-dark">
            <a class="navbar-brand logo" href="/"><span class="text-warning">SELL</span>PHONE</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Nhân viên</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/product">Sản phẩm</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/customer">Khách hàng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/report">Báo cáo</a>
                    </li>
                </ul>
            </div>
            <div>
                <ul class="navbar-nav">
                    <li class="dropdown">
                        <a class="dropdown-toggle nameUser" data-toggle="dropdown" href="#"
                            style="color: rgb(249, 249, 249); list-style: none;" id="userEmail"><%= user.email %>
                            <span class="caret"></span></a>
                        <ul class="dropdown-menu" style="padding: 20px;">
                            <li id="profileUser"><a href="/profile" style="color: black; list-style: none;">Tài khoản</a></li>
                            <li><a href="#" style="color: black; list-style: none;" data-target="#changePasswordModal"
                                    data-toggle="modal">Đổi mật khẩu</a></li>
                            <li><a href="/logout" style="color: black; list-style: none;">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>



    <div class="container" style="margin-top: 80px;">
        <h1 style="margin-top: 20px;">Danh sách nhân viên</h1>
        <section id="content__top">
            <button class="btn btn-success" style="margin-bottom: 20px;" data-toggle="modal"
                data-target="#addStaff">Thêm
                nhân viên</button>
        </section>
        <section id="content__bottom">
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4" ">
                        <div class="card mb-4">
                            <table id="" class="table" style="text-align: center;">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Avatar</th>
                                        <th>Họ và tên</th>
                                        <th>Email</th>
                                        <th>Kích hoạt</th>
                                        <th>Khóa</th>
                                        <th>Quyền hạn</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="listUser">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </section>
    </div>

    <div class="modal fade" id="addStaff" tabindex="-1" role="dialog" aria-labelledby="addStaff" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Thêm nhân viên</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="" class="container">
                        <div class="form-group">
                            <label for="staffName">Tên nhân viên:</label>
                            <input type="text" class="form-control" id="fullnameAdd" placeholder="Nhập tên nhân viên"
                                name="fullname" value="">
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" class="form-control" id="emailAdd" placeholder="Nhập email" name="email"
                                value="">
                        </div>
                        <div class="form-group">
                            <div class="alert alert-danger alert-dismissible fade show" id="addWarning"
                                style="display: none;">
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-success" id="addButton"
                                onclick="checkAdd()">Thêm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="deleteModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Đổi mật khẩu</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="bodyChangePasswordModal">
                    <div class="form-group">
                        <label for="newPsw">Mật khẩu mới</label>
                        <input class="form-control" id="newPassword" type="password"
                            placeholder="Vui lòng nhập mật khẩu mới" />
                    </div>
                    <div class="form-group">
                        <label for="conformPsw">Nhập lại mật khẩu mới</label>
                        <input class="form-control" id="confirmNewPassword" type="password"
                            placeholder="Nhập lại mật khẩu mới" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="butoon" class="btn btn-danger" onclick="checkChangePassword()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Xóa nhân viên</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="bodyDeleteModal">
                    <p>Bạn có chắc muốn xóa tài khoản nhân viên này ?</p>
                </div>
                <input type="hidden" id="emailDelete">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="butoon" class="btn btn-danger" onclick=deleteUser() data-dismiss="modal">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editStaff" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="editStaff" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Cập nhật nhân viên</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="" class="container">
                        <div class="form-group">
                            <label for="email" style="margin-bottom: 5px;">Email:</label>
                            <input type="email" class="form-control" id="editEmail" name="email" value="email" disabled>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="fullName" style="margin-bottom: 5px;">Tên nhân viên:</label>
                            <input type="text" class="form-control" id="editFullname" name="editFullname" value="">
                        </div>
                        <div class="form-group" style="margin-top: 30px;">
                            <label for="gender">Giới tính:</label>
                            <input type="radio" id="editGenderFemale" name="gender" value="Nữ">
                            <label for="female">Nữ</label>
                            <input type="radio" id="editGenderMale" name="gender" value="Nam">
                            <label for="male">Nam</label>
                        </div>
                        <div class="form-group" style="margin-top: 30px;">
                            <label for="birthday" style="margin-bottom: 5px;">Birthday:</label>
                            <input type="date" class="form-control" id="editBirthday" placeholder="" name="birthday"
                                value="">
                        </div>
                        <div class="form-group form-check form-switch" style="margin-top: 30px;">
                            <input class="form-check-input" type="checkbox" id="editIsLock">
                            <label class="form-check-label" for="isLock">IsLock</label>
                        </div>
                        <div class="" style="margin-top: 20px;">
                            <label class="form-label" for="role">Status</label>
                            <select class="form-select" name="editIsActive" id="editIsActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group form-check form-switch" style="margin-top: 30px;">
                            <input class="form-check-input" type="checkbox" id="editIsFirstLogin">
                            <label class="form-check-label" for="isFirstLogin">isFirstLogin</label>
                        </div>
                        <div class="" style="margin-top: 20px;">
                            <label class="form-label" for="role">Role</label>
                            <select class="form-select" name="editRole" id="editRole" id="role">
                                <option value="ADMIN">Admin</option>
                                <option value="STAFF">Staff</option>
                            </select>
                        </div>
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="checkEdit()">Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <%- include('./include/lib') -%>
        <script src="../public/js/staffAPI.js"></script>
        <script src="../public/js/authAPI.js"></script>
</body>

<script>
    const csrfToken = "<%=locals.csrfToken%>";
    $(function () {
        getUserList();
        $("body").on("click", "#deleteButton", function (e) {
            var email = $(e.target).closest('tr').find("#email").html();
            $("#bodyDeleteModal").html(`<p>Bạn có chắc muốn xóa tài khoản <b>${email} </b>này ?</p>`)
            $('#emailDelete').val(email);
        });
        $("body").on("click", "#editButton", function (e) {
            $('#editStaff').show();
            $('.modal-backdrop').show();
            var email = $(e.target).closest('tr').find("#email").html();
            getOneUserByEmail(email);
        });
        $("body").on("click", "#resendMailButton", function (e) {
            var email = $(e.target).closest('tr').find("#email").html();
            var activeStatus = $(e.target).closest('tr').find("#activeStatus").html();
            if (activeStatus == "Actived") {
                showNotification("Tài khoản đã được kích hoạt.");
            }
            else {
                resendMail(email);
            }
        });
        
    });

    function showAlert(message) {
        $("#addWarning").html(message)
        $("#addWarning").show()
        setTimeout(function () {
            $("#addWarning").hide();
        }, 2000);
    }

    function showNotification(message) {
        $("#myNotification").html(message);
        $("#myNotification").show();
        setTimeout(function () {
            $("#myNotification").hide();
        }, 2000);
    }

    function checkAdd() {
        const user = {
            email: $('#emailAdd').val(),
            fullname: $('#fullnameAdd').val()
        }
        var emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
        if (user.fullname.trim() == "" || user.email.trim() == "") {
            showAlert("Vui lòng nhập đủ thông tin!");
        }
        else if (!emailRegex.test(user.email.trim())) {
            showAlert("Email không hợp lệ!");
        }
        else {
            $('#emailAdd').val("");
            $('#fullnameAdd').val("");
            $('#addStaff').hide();
            $('.modal-backdrop').hide();
            createUser(user);
        }
    }

    function checkChangePassword() {
        var newPassword = $('#newPassword').val();
        var confirmNewPassword = $('#confirmNewPassword').val();
        if (newPassword != confirmNewPassword) {
            showNotification("Xác nhận mật khẩu không đúng!")
        }
        else if (newPassword.length < 5) {
            showNotification("Đặt mật khẩu dài xíu nhe!")
        }
        else {
            $('#changePasswordModal').hide();
            $('.modal-backdrop').hide();
            changePassword(newPassword);
        }
    }

    function checkEdit() {
        if ($('#editFullname').val().trim() == "") {
            showNotification("Vui lòng nhập tên người dùng!")
        }
        else {
            dataUpdate = {
                email: $('#editEmail').val(),
                fullName: $('#editFullname').val(),
                gender: $('#editGenderMale').prop('checked') == true ? "MALE" : $('#editGenderFemale').prop('checked') == true ? "FEMALE" : "",
                birthday: $('#editBirthday').val(),
                isLock: $('#editIsLock').prop('checked'),
                isFirstLogin: $('#editIsFirstLogin').prop('checked'),
                isActive: $('#editIsActive').val() == "true" ? true : false,
                role: $('#editRole').val(),
            }
            $('#editStaff').hide();
            $('.modal-backdrop').hide();
            console.log($('#editIsFirstLogin').val())
            console.log(dataUpdate)
            updateUser(dataUpdate);
        }

    }
   
    function updateLock(email, selectElement) {
        changeLockStatus(email, selectElement.checked);
    }
</script>

</html>